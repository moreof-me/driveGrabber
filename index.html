class ImageGenerator {
    constructor() {
        this.currentFolder = 'Lilia';
        this.captions = [];
        this.maxImages = 50; // Maximum number to check
        
        this.init();
    }
    
    async init() {
        await this.loadCaptions();
        this.setupEventListeners();
        this.updateFolderButtons();
    }
    
    async loadCaptions() {
        try {
            const response = await fetch('captions.txt');
            if (!response.ok) throw new Error('Failed to load captions');
            
            const text = await response.text();
            this.captions = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            console.log(`Loaded ${this.captions.length} captions`);
        } catch (error) {
            console.error('Error loading captions:', error);
            this.captions = ['A beautiful moment captured.', 'Memories to cherish forever.'];
        }
    }
    
    setupEventListeners() {
        document.querySelectorAll('.folder-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const folder = e.target.dataset.folder;
                this.selectFolder(folder);
            });
        });
        
        document.getElementById('generate-btn').addEventListener('click', () => {
            this.generateRandomImage();
        });
    }
    
    selectFolder(folder) {
        this.currentFolder = folder === 'random' 
            ? ['Lilia', 'Leylah'][Math.floor(Math.random() * 2)]
            : folder;
        
        this.updateFolderButtons();
    }
    
    updateFolderButtons() {
        document.querySelectorAll('.folder-btn').forEach(btn => {
            const folder = btn.dataset.folder;
            if (folder === 'random') {
                btn.classList.toggle('active', this.currentFolder === 'random');
            } else {
                btn.classList.toggle('active', folder === this.currentFolder);
            }
        });
    }
    
    async getRandomImageNumber(folder) {
        // Try to find how many images exist by checking sequentially
        const validNumbers = [];
        
        // Check common extensions
        const extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
        
        // Check first 50 numbers (adjust as needed)
        for (let i = 1; i <= this.maxImages; i++) {
            for (const ext of extensions) {
                const imageUrl = `${folder}/${i}${ext}`;
                if (await this.imageExists(imageUrl)) {
                    validNumbers.push(i);
                    break; // Found this number with one extension
                }
            }
        }
        
        if (validNumbers.length === 0) return null;
        return validNumbers[Math.floor(Math.random() * validNumbers.length)];
    }
    
    async imageExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch {
            return false;
        }
    }
    
    async generateRandomImage() {
        try {
            const folder = this.currentFolder;
            const imageNumber = await this.getRandomImageNumber(folder);
            
            if (!imageNumber) {
                throw new Error(`No images found in ${folder} folder. Please ensure images are named 1.jpg, 2.jpg, etc.`);
            }
            
            // Try different extensions
            const extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
            let imageUrl = '';
            
            for (const ext of extensions) {
                const testUrl = `${folder}/${imageNumber}${ext}`;
                if (await this.imageExists(testUrl)) {
                    imageUrl = testUrl;
                    break;
                }
            }
            
            if (!imageUrl) {
                throw new Error(`Image ${imageNumber} not found in ${folder} folder`);
            }
            
            // Select random caption
            const randomCaption = this.captions.length > 0
                ? this.captions[Math.floor(Math.random() * this.captions.length)]
                : 'A beautiful moment captured.';
            
            // Update UI
            this.displayImage(imageUrl);
            this.displayCaption(randomCaption, folder);
            
        } catch (error) {
            console.error('Error generating image:', error);
            this.displayError(error.message);
        }
    }
    
    displayImage(imageUrl) {
        const imgElement = document.getElementById('random-image');
        const placeholder = document.getElementById('image-placeholder');
        
        imgElement.onload = () => {
            placeholder.classList.add('hidden');
            imgElement.classList.remove('hidden');
        };
        
        imgElement.onerror = () => {
            this.displayError(`Failed to load image: ${imageUrl}`);
        };
        
        imgElement.src = `${imageUrl}?t=${Date.now()}`;
    }
    
    displayCaption(caption, folder) {
        document.getElementById('caption-text').textContent = caption;
        document.getElementById('image-source').textContent = `Source: ${folder} folder`;
    }
    
    displayError(message) {
        document.getElementById('caption-text').textContent = `Error: ${message}`;
        document.getElementById('image-source').textContent = 'Source: Error occurred';
        
        const imgElement = document.getElementById('random-image');
        const placeholder = document.getElementById('image-placeholder');
        
        imgElement.classList.add('hidden');
        placeholder.classList.remove('hidden');
        placeholder.innerHTML = `<i class="fas fa-exclamation-triangle"></i><p>${message}</p>`;
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    new ImageGenerator();
});
